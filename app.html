<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Priii!</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --bg: #0a0f1e;
            --surface: #111827;
            --surface2: #1e2a3a;
            --surface3: #243044;
            --accent: #3b82f6;
            --accent2: #6366f1;
            --text: #f1f5f9;
            --muted: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }
        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* HEADER */
        .header {
            background: var(--surface);
            border-bottom: 1px solid rgba(255,255,255,0.06);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-logo {
            font-family: 'Syne', sans-serif;
            font-weight: 800;
            font-size: 18px;
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header-user {
            font-size: 13px;
            color: var(--muted);
        }
        .btn-logout {
            background: none;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 6px 12px;
            color: var(--muted);
            font-size: 12px;
            cursor: pointer;
        }

        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-top: 1px solid rgba(255,255,255,0.06);
            display: flex;
            z-index: 100;
        }
        .nav-btn {
            flex: 1;
            padding: 12px 8px;
            background: none;
            border: none;
            color: var(--muted);
            font-size: 11px;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: color 0.2s;
        }
        .nav-btn.active { color: var(--accent); }
        .nav-btn .icon { font-size: 20px; }

        /* SCREENS */
        .screen { display: none; padding: 20px; }
        .screen.active { display: block; }

        /* SECTION TITLE */
        .section-title {
            font-family: 'Syne', sans-serif;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .section-sub {
            color: var(--muted);
            font-size: 13px;
            margin-bottom: 24px;
        }

        /* CARDS */
        .card {
            background: var(--surface);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .card-title {
            font-family: 'Syne', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 14px;
        }

        /* TEMA SELECT */
        .tema-list { display: flex; flex-direction: column; gap: 8px; }
        .tema-item {
            background: var(--surface2);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 14px 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .tema-item.selected {
            border-color: var(--accent);
            background: rgba(59,130,246,0.1);
        }
        .tema-item-name { font-size: 14px; font-weight: 500; }
        .tema-item-count {
            font-size: 12px;
            color: var(--muted);
            background: var(--surface3);
            padding: 3px 8px;
            border-radius: 20px;
        }
        .tema-padre-row {
            display: flex;
            align-items: center;
            gap: 0;
        }
        .tema-padre-row .tema-item {
            flex: 1;
            min-width: 0;
        }
        .btn-expand {
            background: var(--surface2);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 14px 12px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            margin-left: 4px;
        }
        .btn-expand:active { transform: scale(0.9); }
        .btn-expand .arrow { transition: transform 0.2s; display: inline-block; }
        .btn-expand.expanded .arrow { transform: rotate(180deg); }
        .subtemas-collapsible {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .subtemas-collapsible.expanded {
            max-height: 2000px;
        }
        .subtema-item {
            margin-left: 16px;
            border-left: 2px solid var(--surface3);
            padding-left: 12px;
        }
        .subtema-item .tema-item {
            background: var(--bg);
        }
        .btn-ultima-seleccion {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background: var(--surface2);
            border: 2px dashed var(--accent);
            border-radius: 12px;
            color: var(--accent);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: none;
        }
        .btn-ultima-seleccion:active {
            transform: scale(0.97);
            background: rgba(59,130,246,0.1);
        }

        /* CANTIDAD BUTTONS */
        .cantidad-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .btn-cantidad {
            background: var(--surface2);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 14px 8px;
            color: var(--text);
            font-size: 15px;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .btn-cantidad.selected {
            border-color: var(--accent);
            background: rgba(59,130,246,0.1);
            color: var(--accent);
        }

        /* NOMBRE INPUT */
        .nombre-input {
            width: 100%;
            background: var(--surface2);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 14px 16px;
            color: var(--text);
            font-size: 15px;
            font-family: 'DM Sans', sans-serif;
            outline: none;
        }
        .nombre-input:focus { border-color: var(--accent); }

        /* BTN EMPEZAR */
        .btn-empezar {
            width: 100%;
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            border: none;
            border-radius: 14px;
            padding: 18px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            margin-top: 8px;
            transition: opacity 0.2s, transform 0.1s;
        }
        .btn-empezar:active { transform: scale(0.98); }
        .btn-empezar:disabled { opacity: 0.4; cursor: not-allowed; }

        /* ===== TEST EN EJECUCION ===== */
        #testScreen { display: none; }
        #testScreen.active { display: block; }

        .test-header {
            background: var(--surface);
            border-bottom: 1px solid rgba(255,255,255,0.06);
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .test-progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .test-nombre { font-size: 13px; color: var(--muted); }
        .test-counter { font-size: 13px; color: var(--accent); font-weight: 600; }
        .progress-bar {
            height: 4px;
            background: var(--surface2);
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            border-radius: 2px;
            transition: width 0.3s;
        }

        .pregunta-card {
            background: var(--surface);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 16px;
            padding: 20px;
            margin: 16px;
            margin-bottom: 12px;
        }
        .pregunta-num {
            font-size: 11px;
            color: var(--accent);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 10px;
        }
        .pregunta-tema-tag {
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 12px;
        }
        .pregunta-texto {
            font-size: 15px;
            line-height: 1.6;
            font-weight: 500;
        }

        .opciones-container { padding: 0 16px; }
        .opcion-btn {
            width: 100%;
            background: var(--surface);
            border: 2px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 16px;
            color: var(--text);
            font-size: 14px;
            font-family: 'DM Sans', sans-serif;
            text-align: left;
            cursor: pointer;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transition: all 0.15s;
            line-height: 1.4;
        }
        .opcion-btn:active { transform: scale(0.99); }
        .opcion-btn.selected { border-color: var(--accent); background: rgba(59,130,246,0.1); }
        .opcion-btn.correcta { border-color: var(--success); background: rgba(16,185,129,0.1); }
        .opcion-btn.incorrecta { border-color: var(--danger); background: rgba(239,68,68,0.1); }
        .opcion-letra {
            min-width: 28px;
            height: 28px;
            background: var(--surface2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: var(--muted);
            flex-shrink: 0;
        }
        .opcion-btn.selected .opcion-letra { background: var(--accent); color: white; }
        .opcion-btn.correcta .opcion-letra { background: var(--success); color: white; }
        .opcion-btn.incorrecta .opcion-letra { background: var(--danger); color: white; }

        .btn-siguiente {
            display: block;
            width: calc(100% - 32px);
            margin: 0 16px 16px;
            background: var(--surface);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 16px;
            color: var(--text);
            font-size: 15px;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .btn-siguiente.ready {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            border-color: transparent;
        }
        .btn-siguiente:disabled { opacity: 0.3; cursor: not-allowed; }

        .feedback-msg {
            margin: 0 16px 12px;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            display: none;
        }
        .feedback-msg.correcto { background: rgba(16,185,129,0.1); color: #6ee7b7; border: 1px solid rgba(16,185,129,0.3); }
        .feedback-msg.incorrecto { background: rgba(239,68,68,0.1); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); }

        /* ===== RESULTADOS ===== */
        .resultado-hero {
            text-align: center;
            padding: 32px 20px 24px;
        }
        .resultado-emoji { font-size: 52px; margin-bottom: 12px; }
        .resultado-fraccion {
            font-family: 'Syne', sans-serif;
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 8px;
        }
        .resultado-fraccion.bueno { color: var(--success); }
        .resultado-fraccion.malo { color: var(--danger); }
        .resultado-fraccion.medio { color: var(--warning); }
        .resultado-msg { color: var(--muted); font-size: 15px; }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 0 20px 20px;
        }
        .stat-box {
            background: var(--surface);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 14px;
            padding: 16px;
            text-align: center;
        }
        .stat-box .num { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 700; }
        .stat-box .lbl { font-size: 11px; color: var(--muted); margin-top: 4px; }
        .stat-box.c .num { color: var(--success); }
        .stat-box.f .num { color: var(--danger); }
        .stat-box.s .num { color: var(--muted); }

        .revision-list { padding: 0 20px 20px; }
        .revision-item {
            background: var(--surface);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .revision-item.correcta { border-left: 3px solid var(--success); }
        .revision-item.incorrecta { border-left: 3px solid var(--danger); }
        .revision-item.sin-respuesta { border-left: 3px solid var(--muted); }
        .revision-estado {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
        }
        .revision-estado.correcta { color: var(--success); }
        .revision-estado.incorrecta { color: var(--danger); }
        .revision-estado.sin-respuesta { color: var(--muted); }
        .revision-pregunta { font-size: 14px; line-height: 1.5; margin-bottom: 10px; }
        .revision-opciones { display: flex; flex-direction: column; gap: 6px; }
        .rev-opcion {
            font-size: 13px;
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--surface2);
        }
        .rev-opcion.correcta { background: rgba(16,185,129,0.1); color: #6ee7b7; }
        .rev-opcion.mi-resp { background: rgba(239,68,68,0.1); color: #fca5a5; }

        .btn-nuevo-test {
            display: block;
            width: calc(100% - 40px);
            margin: 0 20px 20px;
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            border: none;
            border-radius: 14px;
            padding: 18px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            text-align: center;
        }

        /* ===== HISTORIAL ===== */
        .historial-item {
            background: var(--surface);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .hist-score {
            font-family: 'Syne', sans-serif;
            font-size: 20px;
            font-weight: 700;
            min-width: 52px;
            text-align: center;
        }
        .hist-score.bueno { color: var(--success); }
        .hist-score.malo { color: var(--danger); }
        .hist-score.medio { color: var(--warning); }
        .hist-info { flex: 1; }
        .hist-nombre { font-size: 14px; font-weight: 500; margin-bottom: 3px; }
        .hist-fecha { font-size: 12px; color: var(--muted); }
        .hist-tema { font-size: 11px; color: var(--muted); margin-top: 2px; }
        .btn-borrar-test {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 18px;
            padding: 8px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .btn-borrar-test:active { opacity: 1; transform: scale(1.2); }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--muted);
        }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
        .empty-state p { font-size: 14px; }

        /* LOADING */
        .spinner-container {
            display: flex;
            justify-content: center;
            padding: 40px;
        }
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--surface2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* CARD FALLADAS */
        .card-falladas {
            background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(249,115,22,0.08));
            border: 1px solid rgba(239,68,68,0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            display: none;
        }
        .card-falladas .falladas-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .card-falladas .falladas-titulo {
            font-family: 'Syne', sans-serif;
            font-size: 15px;
            font-weight: 700;
            color: var(--danger);
        }
        .card-falladas .falladas-count {
            font-size: 12px;
            color: var(--danger);
            background: rgba(239,68,68,0.15);
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
        }
        .card-falladas .falladas-desc {
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 14px;
            line-height: 1.5;
        }
        .btn-falladas {
            width: 100%;
            background: linear-gradient(135deg, #ef4444, #f97316);
            border: none;
            border-radius: 12px;
            padding: 14px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-falladas:active { transform: scale(0.98); }

        /* HISTORIAL CLICABLE */
        .historial-item { cursor: pointer; transition: background 0.2s; }
        .historial-item:active { background: var(--surface2); }

        /* OVERLAY DETALLE HISTORIAL */
        .overlay-detalle {
            display: none;
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 200;
            overflow-y: auto;
            padding-bottom: 40px;
        }
        .overlay-detalle.visible { display: block; }
        .overlay-detalle-header {
            background: var(--surface);
            border-bottom: 1px solid rgba(255,255,255,0.06);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .btn-volver-hist {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 22px;
            cursor: pointer;
            padding: 4px;
        }
        .overlay-detalle-titulo {
            font-family: 'Syne', sans-serif;
            font-size: 16px;
            font-weight: 700;
        }

        /* MODAL EXPLICACI√ìN */
        .modal-explicacion {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 300;
            justify-content: center;
            align-items: flex-end;
        }
        .modal-explicacion.visible { display: flex; }
        .modal-explicacion-body {
            background: var(--surface);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .modal-expl-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .modal-expl-title {
            font-family: 'Syne', sans-serif;
            font-size: 16px;
            font-weight: 700;
        }
        .btn-cerrar-expl {
            background: var(--surface2);
            border: none;
            color: var(--text);
            font-size: 18px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .expl-content {
            font-size: 14px;
            line-height: 1.7;
            color: var(--text);
            white-space: pre-wrap;
        }
        .expl-empty {
            text-align: center;
            padding: 30px 20px;
            color: var(--muted);
            font-size: 14px;
        }
        .btn-ver-explicacion {
            background: var(--surface2);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--accent);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .btn-ver-explicacion:active { transform: scale(0.97); }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 2px; }
    </style>
</head>
<body>

<!-- HEADER -->
<div class="header" id="mainHeader">
    <div class="header-logo">üí• Priii!</div>
    <button class="btn-logout" onclick="logout()">Salir</button>
</div>

<!-- SCREEN: CONFIGURAR TEST -->
<div class="screen active" id="configScreen">
    <div class="section-title">Nuevo Test</div>
    <div class="section-sub">Configura tu pr√°ctica</div>

    <!-- Card Test Falladas -->
    <div class="card-falladas" id="cardFalladas">
        <div class="falladas-header">
            <span class="falladas-titulo">üîÑ Test de Repaso</span>
            <span class="falladas-count" id="falladasCount">0 preguntas</span>
        </div>
        <div class="falladas-desc">Repasa las preguntas que has fallado. Las que aciertes se eliminar√°n autom√°ticamente.</div>
        <button class="btn-falladas" onclick="empezarTestFalladas()">Empezar Test de Repaso</button>
    </div>

    <!-- Nombre -->
    <div class="card">
        <div class="card-title">Nombre del test</div>
        <input type="text" class="nombre-input" id="nombreTest" placeholder="Ej: Pr√É¬°ctica tema 3">
    </div>

    <!-- Temas -->
    <div class="card">
        <div class="card-title">Tema</div>
        <div class="tema-list" id="temaList">
            <div class="spinner-container"><div class="spinner"></div></div>
        </div>
    </div>

    <!-- Cantidad -->
    <div class="card">
        <div class="card-title">N√∫mero de preguntas</div>
        <div class="cantidad-grid">
            <button class="btn-cantidad selected" data-n="10" onclick="seleccionarCantidad(this)">10</button>
            <button class="btn-cantidad" data-n="20" onclick="seleccionarCantidad(this)">20</button>
            <button class="btn-cantidad" data-n="30" onclick="seleccionarCantidad(this)">30</button>
            <button class="btn-cantidad" data-n="50" onclick="seleccionarCantidad(this)">50</button>
        </div>
    </div>

    <button class="btn-empezar" id="btnEmpezar" onclick="empezarTest()">Empezar Test</button>
</div>

<!-- SCREEN: TEST EN EJECUCI√ìN -->
<div id="testScreen">
    <div class="test-header">
        <div class="test-progress-info">
            <span class="test-nombre" id="testNombreHeader"></span>
            <span class="test-counter" id="testCounter">0/0</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width:0%"></div>
        </div>
    </div>

    <div class="pregunta-card" id="preguntaCard">
        <div class="pregunta-num" id="preguntaNum"></div>
        <div class="pregunta-tema-tag" id="preguntaTema"></div>
        <div class="pregunta-texto" id="preguntaTexto"></div>
    </div>

    <div class="opciones-container" id="opcionesContainer"></div>

    <div class="feedback-msg" id="feedbackMsg"></div>

    <button class="btn-siguiente" id="btnSiguiente" disabled onclick="siguientePregunta()">
        Selecciona una respuesta
    </button>
</div>

<!-- SCREEN: RESULTADOS -->
<div id="resultadosScreen" style="display:none">
    <div class="resultado-hero">
        <div class="resultado-emoji" id="resEmoji"></div>
        <div class="resultado-fraccion" id="resFraccion"></div>
        <div class="resultado-msg" id="resMsg"></div>
    </div>
    <div class="stats-row">
        <div class="stat-box c"><div class="num" id="resCorrectas">0</div><div class="lbl">Correctas</div></div>
        <div class="stat-box f"><div class="num" id="resIncorrectas">0</div><div class="lbl">Falladas</div></div>
        <div class="stat-box s"><div class="num" id="resSin">0</div><div class="lbl">Sin resp.</div></div>
    </div>
    <button class="btn-nuevo-test" onclick="nuevoTest()">Hacer otro test</button>
    <div class="revision-list" id="revisionList"></div>
</div>

<!-- SCREEN: HISTORIAL -->
<div class="screen" id="historialScreen">
    <div class="section-title">Historial</div>
    <div class="section-sub">Tus tests realizados</div>
    <div id="historialList">
        <div class="spinner-container"><div class="spinner"></div></div>
    </div>
</div>

<!-- OVERLAY DETALLE TEST -->
<div class="overlay-detalle" id="overlayDetalle">
    <div class="overlay-detalle-header">
        <button class="btn-volver-hist" onclick="cerrarDetalleHistorial()">‚Üê</button>
        <div class="overlay-detalle-titulo" id="detalleTitulo">Detalle del test</div>
    </div>
    <div id="detalleContenido" style="padding: 16px;"></div>
</div>

<!-- MODAL EXPLICACI√ìN -->
<div class="modal-explicacion" id="modalExplicacion" onclick="cerrarExplicacionModal(event)">
    <div class="modal-explicacion-body" onclick="event.stopPropagation()">
        <div class="modal-expl-header">
            <span class="modal-expl-title">üìñ Explicaci√≥n</span>
            <button class="btn-cerrar-expl" onclick="cerrarExplicacionModal()">‚úï</button>
        </div>
        <div id="explicacionContenido">
            <div class="expl-empty">Cargando...</div>
        </div>
    </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav" id="bottomNav">
    <button class="nav-btn active" id="navTest" onclick="goTo('test')">
        <span class="icon">‚úèÔ∏è</span>
        <span>Test</span>
    </button>
    <button class="nav-btn" id="navHistorial" onclick="goTo('historial')">
        <span class="icon">üìã</span>
        <span>Historial</span>
    </button>
</nav>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, query, where, getDocs, addDoc, orderBy, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { firebaseConfig } from './firebase-config.js';

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let temasData = [];
let temasSeleccionados = new Set();
let cantidadSeleccionada = 10;
let testActual = null;
let preguntaIndex = 0;
let respuestasUsuario = {};
let respondidaActual = false;

// Hash consistente con la plataforma
function generarHashPregunta(texto) {
    const preguntaTexto = texto || '';
    let hash = 0;
    for (let i = 0; i < preguntaTexto.length; i++) {
        const char = preguntaTexto.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return 'q_' + Math.abs(hash).toString(36);
}

// AUTH
onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = 'index.html'; return; }
    currentUser = user;
    await cargarTemas();
    cargarContadorFalladas();
});

window.logout = async function() {
    await signOut(auth);
    window.location.href = 'index.html';
};

// NAVEGACI√ìN
window.goTo = function(tab) {
    document.getElementById('navTest').classList.remove('active');
    document.getElementById('navHistorial').classList.remove('active');
    document.getElementById('configScreen').classList.remove('active');
    document.getElementById('historialScreen').classList.remove('active');
    document.getElementById('testScreen').style.display = 'none';
    document.getElementById('resultadosScreen').style.display = 'none';
    document.getElementById('mainHeader').style.display = 'flex';
    document.getElementById('bottomNav').style.display = 'flex';

    if (tab === 'test') {
        document.getElementById('navTest').classList.add('active');
        document.getElementById('configScreen').classList.add('active');
        cargarContadorFalladas();
    } else {
        document.getElementById('navHistorial').classList.add('active');
        document.getElementById('historialScreen').classList.add('active');
        cargarHistorial();
    }
};

// CARGAR TEMAS
async function cargarTemas() {
    const q = query(collection(db, "temas"), where("usuarioId", "==", currentUser.uid));
    const snap = await getDocs(q);

    const principales = [];
    const subtemasPorPadre = {};

    snap.forEach(doc => {
        const t = doc.data();
        const pv = (t.preguntas || []).filter(p => p.verificada).length;
        if (t.temaPadreId) {
            if (!subtemasPorPadre[t.temaPadreId]) subtemasPorPadre[t.temaPadreId] = [];
            subtemasPorPadre[t.temaPadreId].push({ id: doc.id, nombre: t.nombre, pv });
        } else {
            let pvTotal = pv;
            principales.push({ id: doc.id, nombre: t.nombre, pv, pvTotal });
        }
    });

    principales.forEach(t => {
        if (subtemasPorPadre[t.id]) {
            t.pvTotal += subtemasPorPadre[t.id].reduce((s, st) => s + st.pv, 0);
        }
    });

    principales.sort((a, b) => {
        const na = a.nombre.match(/\d+/), nb = b.nombre.match(/\d+/);
        if (na && nb) return parseInt(na[0]) - parseInt(nb[0]);
        return a.nombre.localeCompare(b.nombre);
    });

    temasData = [];
    const container = document.getElementById('temaList');
    container.innerHTML = '';

    // Bot√≥n √∫ltima selecci√≥n
    const ultimaSel = localStorage.getItem('ultimaSeleccionTemas');
    const btnUltima = document.createElement('button');
    btnUltima.className = 'btn-ultima-seleccion';
    btnUltima.textContent = 'üîÑ Usar √∫ltima selecci√≥n de temas';
    if (ultimaSel) btnUltima.style.display = 'block';
    btnUltima.onclick = () => aplicarUltimaSeleccion();
    container.appendChild(btnUltima);

    // Opci√≥n "Todos"
    const todosDiv = document.createElement('div');
    todosDiv.className = 'tema-item selected';
    todosDiv.dataset.id = 'todos';
    todosDiv.innerHTML = `<span class="tema-item-name">üìö Todos los temas</span><span class="tema-item-count">todas</span>`;
    todosDiv.onclick = () => seleccionarTema(todosDiv, 'todos');
    container.appendChild(todosDiv);
    temasSeleccionados.add('todos');

    principales.forEach(t => {
        temasData.push(t);
        const tieneSubtemas = subtemasPorPadre[t.id] && subtemasPorPadre[t.id].length > 0;

        if (tieneSubtemas) {
            // Fila padre con bot√≥n expand
            const row = document.createElement('div');
            row.className = 'tema-padre-row';

            const div = document.createElement('div');
            div.className = 'tema-item';
            div.dataset.id = t.id;
            div.innerHTML = `<span class="tema-item-name">${t.nombre}</span><span class="tema-item-count">${t.pvTotal}</span>`;
            div.onclick = () => seleccionarTema(div, t.id);

            const btnExp = document.createElement('button');
            btnExp.className = 'btn-expand';
            btnExp.innerHTML = '<span class="arrow">‚ñº</span>';
            
            // Contenedor subtemas colapsable
            const subContainer = document.createElement('div');
            subContainer.className = 'subtemas-collapsible';

            btnExp.onclick = (e) => {
                e.stopPropagation();
                btnExp.classList.toggle('expanded');
                subContainer.classList.toggle('expanded');
            };

            row.appendChild(div);
            row.appendChild(btnExp);
            container.appendChild(row);

            subtemasPorPadre[t.id].forEach(st => {
                temasData.push(st);
                const wrapper = document.createElement('div');
                wrapper.className = 'subtema-item';
                const sdiv = document.createElement('div');
                sdiv.className = 'tema-item';
                sdiv.dataset.id = st.id;
                sdiv.innerHTML = `<span class="tema-item-name">‚Ü≥ ${st.nombre}</span><span class="tema-item-count">${st.pv}</span>`;
                sdiv.onclick = () => seleccionarTema(sdiv, st.id);
                wrapper.appendChild(sdiv);
                subContainer.appendChild(wrapper);
            });

            container.appendChild(subContainer);
        } else {
            // Tema sin subtemas, igual que antes
            const div = document.createElement('div');
            div.className = 'tema-item';
            div.dataset.id = t.id;
            div.innerHTML = `<span class="tema-item-name">${t.nombre}</span><span class="tema-item-count">${t.pvTotal}</span>`;
            div.onclick = () => seleccionarTema(div, t.id);
            container.appendChild(div);
        }
    });
}

function aplicarUltimaSeleccion() {
    const guardada = localStorage.getItem('ultimaSeleccionTemas');
    if (!guardada) return;
    const ids = JSON.parse(guardada);

    // Deseleccionar todo
    document.querySelectorAll('.tema-item').forEach(d => d.classList.remove('selected'));
    temasSeleccionados.clear();

    if (ids.includes('todos')) {
        const todosEl = document.querySelector('[data-id="todos"]');
        if (todosEl) todosEl.classList.add('selected');
        temasSeleccionados.add('todos');
        return;
    }

    ids.forEach(id => {
        const el = document.querySelector(`[data-id="${id}"]`);
        if (el) {
            el.classList.add('selected');
            temasSeleccionados.add(id);
            // Auto-expandir el padre si es subtema
            const subContainer = el.closest('.subtemas-collapsible');
            if (subContainer) {
                subContainer.classList.add('expanded');
                const btnExp = subContainer.previousElementSibling?.querySelector('.btn-expand');
                if (btnExp) btnExp.classList.add('expanded');
            }
        }
    });

    if (temasSeleccionados.size === 0) {
        const todosEl = document.querySelector('[data-id="todos"]');
        if (todosEl) todosEl.classList.add('selected');
        temasSeleccionados.add('todos');
    }
}

window.seleccionarTema = function(el, id) {
    if (id === 'todos') {
        // Seleccionar todos
        document.querySelectorAll('.tema-item').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
        temasSeleccionados = new Set(['todos']);
    } else {
        // Deseleccionar "todos"
        const todosEl = document.querySelector('[data-id="todos"]');
        if (todosEl) todosEl.classList.remove('selected');
        temasSeleccionados.delete('todos');

        if (el.classList.contains('selected')) {
            el.classList.remove('selected');
            temasSeleccionados.delete(id);
        } else {
            el.classList.add('selected');
            temasSeleccionados.add(id);
        }

        if (temasSeleccionados.size === 0) {
            if (todosEl) todosEl.classList.add('selected');
            temasSeleccionados.add('todos');
        }
    }
};

window.seleccionarCantidad = function(btn) {
    document.querySelectorAll('.btn-cantidad').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    cantidadSeleccionada = parseInt(btn.dataset.n);
};

// EMPEZAR TEST
window.empezarTest = async function() {
    const nombre = document.getElementById('nombreTest').value.trim();
    if (!nombre) { alert('Escribe un nombre para el test'); return; }

    // Guardar √∫ltima selecci√≥n de temas
    localStorage.setItem('ultimaSeleccionTemas', JSON.stringify(Array.from(temasSeleccionados)));

    const preguntas = await obtenerPreguntas();
    if (preguntas.length === 0) { alert('No hay preguntas verificadas en los temas seleccionados'); return; }

    const n = Math.min(cantidadSeleccionada, preguntas.length);
    const seleccionadas = mezclar(preguntas).slice(0, n);

    testActual = {
        nombre,
        preguntas: seleccionadas,
        fechaInicio: new Date(),
        temas: Array.from(temasSeleccionados),
        esRepaso: false
    };
    preguntaIndex = 0;
    respuestasUsuario = {};
    respondidaActual = false;

    // Ocultar nav y header
    document.getElementById('bottomNav').style.display = 'none';
    document.getElementById('mainHeader').style.display = 'none';
    document.getElementById('configScreen').classList.remove('active');
    document.getElementById('testScreen').style.display = 'block';
    document.getElementById('resultadosScreen').style.display = 'none';

    mostrarPregunta();
};

async function obtenerPreguntas() {
    const todas = [];
    const q = query(collection(db, "temas"), where("usuarioId", "==", currentUser.uid));
    const snap = await getDocs(q);

    if (temasSeleccionados.has('todos')) {
        snap.forEach(doc => {
            (doc.data().preguntas || []).forEach(p => {
                if (p.verificada) todas.push({ ...p, temaNombre: doc.data().nombre, temaId: doc.id });
            });
        });
    } else {
        // Construir set expandido: si seleccionas un padre, incluir sus subtemas
        const idsExpandidos = new Set(temasSeleccionados);
        snap.forEach(doc => {
            const t = doc.data();
            if (t.temaPadreId && idsExpandidos.has(t.temaPadreId)) {
                idsExpandidos.add(doc.id);
            }
        });

        snap.forEach(doc => {
            if (idsExpandidos.has(doc.id)) {
                (doc.data().preguntas || []).forEach(p => {
                    if (p.verificada) todas.push({ ...p, temaNombre: doc.data().nombre, temaId: doc.id });
                });
            }
        });
    }
    // Eliminar duplicados por texto
    const vistos = new Set();
    return todas.filter(p => {
        const k = p.texto.trim().toLowerCase();
        if (vistos.has(k)) return false;
        vistos.add(k);
        return true;
    });
}

function mezclar(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
        const buf = new Uint32Array(1);
        crypto.getRandomValues(buf);
        const j = buf[0] % (i + 1);
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}

function mostrarPregunta() {
    const total = testActual.preguntas.length;
    const p = testActual.preguntas[preguntaIndex];

    document.getElementById('testNombreHeader').textContent = testActual.nombre;
    document.getElementById('testCounter').textContent = `${preguntaIndex + 1}/${total}`;
    document.getElementById('progressFill').style.width = `${((preguntaIndex) / total) * 100}%`;
    document.getElementById('preguntaNum').textContent = `Pregunta ${preguntaIndex + 1} de ${total}`;
    document.getElementById('preguntaTema').textContent = p.temaNombre || '';
    document.getElementById('preguntaTexto').textContent = p.texto;

    const oc = document.getElementById('opcionesContainer');
    oc.innerHTML = '';
    mezclar(p.opciones).forEach(op => {
        const btn = document.createElement('button');
        btn.className = 'opcion-btn';
        btn.dataset.letra = op.letra;
        btn.innerHTML = `<span class="opcion-letra">${op.letra}</span><span>${op.texto}</span>`;
        btn.onclick = () => seleccionarRespuesta(btn, op.letra, p.respuestaCorrecta);
        oc.appendChild(btn);
    });

    const btnSig = document.getElementById('btnSiguiente');
    btnSig.disabled = true;
    btnSig.className = 'btn-siguiente';
    btnSig.textContent = 'Selecciona una respuesta';

    document.getElementById('feedbackMsg').style.display = 'none';
    respondidaActual = false;
}

function seleccionarRespuesta(btn, letra, correcta) {
    if (respondidaActual) return;
    respondidaActual = true;
    respuestasUsuario[preguntaIndex] = letra;

    // Colorear opciones
    document.querySelectorAll('.opcion-btn').forEach(b => {
        const l = b.dataset.letra;
        if (l === correcta) b.classList.add('correcta');
        else if (l === letra && letra !== correcta) b.classList.add('incorrecta');
        b.style.pointerEvents = 'none';
    });

    // Feedback
    const fb = document.getElementById('feedbackMsg');
    if (letra === correcta) {
        fb.textContent = '‚úÖ ¬°Correcto!';
        fb.className = 'feedback-msg correcto';
    } else {
        fb.textContent = `‚ùå Incorrecto. La correcta era ${correcta})`;
        fb.className = 'feedback-msg incorrecto';
    }
    fb.style.display = 'block';

    const btnSig = document.getElementById('btnSiguiente');
    btnSig.disabled = false;
    btnSig.className = 'btn-siguiente ready';
    const esUltima = preguntaIndex >= testActual.preguntas.length - 1;
    btnSig.textContent = esUltima ? 'Ver Resultados' : 'Siguiente ‚Üí';
}

window.siguientePregunta = function() {
    if (!respondidaActual) return;
    preguntaIndex++;
    if (preguntaIndex >= testActual.preguntas.length) {
        finalizarTest();
    } else {
        mostrarPregunta();
    }
};

async function finalizarTest() {
    let correctas = 0, incorrectas = 0, sin = 0;
    const detalle = testActual.preguntas.map((p, i) => {
        const resp = respuestasUsuario[i];
        let estado = 'sin-respuesta';
        if (resp === p.respuestaCorrecta) { estado = 'correcta'; correctas++; }
        else if (resp) { estado = 'incorrecta'; incorrectas++; }
        else sin++;
        return { pregunta: p, respuestaUsuario: resp, respuestaCorrecta: p.respuestaCorrecta, estado, indice: i + 1 };
    });

    const total = testActual.preguntas.length;
    const pct = Math.round((correctas / total) * 100);

    // Guardar en Firebase
    try {
        await addDoc(collection(db, "resultados"), {
            correctas, incorrectas, sinResponder: sin, total,
            porcentaje: pct,
            tiempoEmpleado: Math.floor((new Date() - testActual.fechaInicio) / 1000),
            test: { nombre: testActual.nombre, tema: testActual.temas, fechaInicio: testActual.fechaInicio },
            detalleRespuestas: detalle.map(d => ({
                indice: d.indice, estado: d.estado,
                respuestaUsuario: d.respuestaUsuario || null,
                respuestaCorrecta: d.respuestaCorrecta,
                pregunta: {
                    texto: d.pregunta.texto,
                    temaNombre: d.pregunta.temaNombre || '',
                    temaId: d.pregunta.temaId || '',
                    opciones: d.pregunta.opciones || []
                }
            })),
            fechaCreacion: new Date(),
            usuarioId: currentUser.uid,
            origen: 'app_movil'
        });
    } catch (e) {
        console.error('Error guardando resultado:', e);
    }

    // Gesti√≥n de falladas
    if (testActual.esRepaso) {
        try {
            const acertadas = detalle.filter(d => d.estado === 'correcta');
            if (acertadas.length > 0) {
                const qf = query(collection(db, "preguntasFalladas"), where("usuarioId", "==", currentUser.uid));
                const snapF = await getDocs(qf);
                const eliminaciones = [];
                snapF.forEach(docSnap => {
                    const textoF = docSnap.data().pregunta?.texto?.trim();
                    if (acertadas.some(a => a.pregunta.texto?.trim() === textoF)) {
                        eliminaciones.push(deleteDoc(docSnap.ref));
                    }
                });
                if (eliminaciones.length > 0) await Promise.all(eliminaciones);
            }
        } catch (e) { console.error('Error gestionando repaso:', e); }
    } else {
        try {
            const falladas = detalle.filter(d => d.estado === 'incorrecta');
            if (falladas.length > 0) {
                const promesas = falladas.map(d => addDoc(collection(db, "preguntasFalladas"), {
                    usuarioId: currentUser.uid,
                    pregunta: {
                        texto: d.pregunta.texto,
                        opciones: d.pregunta.opciones,
                        respuestaCorrecta: d.respuestaCorrecta,
                        temaId: d.pregunta.temaId || '',
                        temaNombre: d.pregunta.temaNombre || ''
                    },
                    respuestaUsuario: d.respuestaUsuario,
                    estado: d.estado,
                    fechaFallo: new Date(),
                    testNombre: testActual.nombre
                }));
                await Promise.all(promesas);
            }
        } catch (e) { console.error('Error guardando falladas:', e); }
    }

    // Mostrar resultados
    document.getElementById('testScreen').style.display = 'none';
    document.getElementById('resultadosScreen').style.display = 'block';

    let emoji = 'üìö', msg = '¬°Sigue practicando!', cls = 'malo';
    if (pct >= 90) { emoji = 'üèÜ'; msg = '¬°Excelente!'; cls = 'bueno'; }
    else if (pct >= 70) { emoji = '‚≠ê'; msg = '¬°Muy bien!'; cls = 'bueno'; }
    else if (pct >= 50) { emoji = 'üìà'; msg = 'Buen intento'; cls = 'medio'; }

    document.getElementById('resEmoji').textContent = emoji;
    document.getElementById('resFraccion').textContent = `${correctas}/${total}`;
    document.getElementById('resFraccion').className = `resultado-fraccion ${cls}`;
    document.getElementById('resMsg').textContent = `${pct}% ‚Äî ${msg}`;
    document.getElementById('resCorrectas').textContent = correctas;
    document.getElementById('resIncorrectas').textContent = incorrectas;
    document.getElementById('resSin').textContent = sin;

    renderizarRevision(detalle, 'revisionList');
}

window.nuevoTest = function() {
    document.getElementById('resultadosScreen').style.display = 'none';
    document.getElementById('mainHeader').style.display = 'flex';
    document.getElementById('bottomNav').style.display = 'flex';
    document.getElementById('configScreen').classList.add('active');
    document.getElementById('navTest').classList.add('active');
    document.getElementById('navHistorial').classList.remove('active');
    cargarContadorFalladas();
};

// HISTORIAL
async function cargarHistorial() {
    const container = document.getElementById('historialList');
    container.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>';

    try {
        const q = query(collection(db, "resultados"), where("usuarioId", "==", currentUser.uid), where("origen", "==", "app_movil"));
        const snap = await getDocs(q);

        if (snap.empty) {
            container.innerHTML = '<div class="empty-state"><div class="icon">üìã</div><p>Todav√≠a no has hecho ning√∫n test</p></div>';
            return;
        }

        const resultados = [];
        snap.forEach(d => resultados.push({ id: d.id, data: d.data() }));

        resultados.sort((a, b) => {
            const fa = a.data.fechaCreacion?.seconds ? new Date(a.data.fechaCreacion.seconds * 1000) : new Date(0);
            const fb2 = b.data.fechaCreacion?.seconds ? new Date(b.data.fechaCreacion.seconds * 1000) : new Date(0);
            return fb2 - fa;
        });

        container.innerHTML = '';
        resultados.forEach(({ id, data: r }) => {
            const fecha = r.fechaCreacion?.seconds ? new Date(r.fechaCreacion.seconds * 1000) : new Date();
            const pct = r.porcentaje || 0;
            let cls = pct >= 70 ? 'bueno' : pct >= 50 ? 'medio' : 'malo';

            const item = document.createElement('div');
            item.className = 'historial-item';
            item.innerHTML = `
                <div class="hist-score ${cls}">${r.correctas}/${r.total}</div>
                <div class="hist-info">
                    <div class="hist-nombre">${r.test?.nombre || 'Test'}</div>
                    <div class="hist-fecha">${fecha.toLocaleDateString('es-ES')} ¬∑ ${fecha.toLocaleTimeString('es-ES', {hour:'2-digit',minute:'2-digit'})}</div>
                </div>
                <button class="btn-borrar-test" data-id="${id}">üóëÔ∏è</button>
            `;
            item.onclick = (e) => {
                if (e.target.closest('.btn-borrar-test')) return;
                abrirDetalleHistorial(r);
            };
            item.querySelector('.btn-borrar-test').onclick = (e) => {
                e.stopPropagation();
                borrarResultado(id, item);
            };
            container.appendChild(item);
        });
    } catch (e) {
        console.error(e);
        container.innerHTML = '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Error cargando historial</p></div>';
    }
}
// ===================== RENDERIZAR REVISI√ìN =====================
function renderizarRevision(detalle, containerId) {
    const rev = document.getElementById(containerId);
    rev.innerHTML = '<div style="font-family:Syne,sans-serif;font-size:16px;font-weight:700;margin-bottom:16px;">Revisi√≥n</div>';
    detalle.forEach(d => {
        const item = document.createElement('div');
        item.className = `revision-item ${d.estado}`;
        const opciones = d.pregunta?.opciones || [];
        const optsHTML = opciones.map(o => {
            let cls = '';
            if (o.letra === d.respuestaCorrecta) cls = 'correcta';
            else if (o.letra === d.respuestaUsuario) cls = 'mi-resp';
            return `<div class="rev-opcion ${cls}">${o.letra}) ${o.texto}${o.letra === d.respuestaCorrecta ? ' ‚úî' : ''}</div>`;
        }).join('');
        const textoPreg = d.pregunta?.texto || '';
        item.innerHTML = `
            <div class="revision-estado ${d.estado}">${d.estado === 'correcta' ? '‚úÖ Correcta' : d.estado === 'incorrecta' ? '‚ùå Incorrecta' : '‚≠ï Sin responder'}</div>
            <div class="revision-pregunta">${d.indice}. ${textoPreg}</div>
            <div class="revision-opciones">${optsHTML}</div>
        `;
        const btnExpl = document.createElement('button');
        btnExpl.className = 'btn-ver-explicacion';
        btnExpl.textContent = 'üìñ Ver explicaci√≥n';
        btnExpl.onclick = () => abrirExplicacion(textoPreg);
        item.appendChild(btnExpl);
        rev.appendChild(item);
    });
}

// ===================== CONTADOR FALLADAS =====================
async function cargarContadorFalladas() {
    if (!currentUser) return;
    try {
        const q = query(collection(db, "preguntasFalladas"), where("usuarioId", "==", currentUser.uid));
        const snap = await getDocs(q);
        const card = document.getElementById('cardFalladas');
        if (snap.empty) { card.style.display = 'none'; return; }
        card.style.display = 'block';
        document.getElementById('falladasCount').textContent = `${snap.size} preguntas`;
    } catch (e) { console.error('Error cargando falladas:', e); }
}

// ===================== TEST FALLADAS =====================
window.empezarTestFalladas = async function() {
    try {
        const q = query(collection(db, "preguntasFalladas"), where("usuarioId", "==", currentUser.uid));
        const snap = await getDocs(q);
        if (snap.empty) { alert('No hay preguntas falladas'); return; }

        const preguntas = [];
        snap.forEach(d => {
            const data = d.data();
            preguntas.push({ ...data.pregunta, temaNombre: data.pregunta.temaNombre || '', temaId: data.pregunta.temaId || '', documentId: d.id });
        });

        const unicas = [];
        const vistos = new Set();
        mezclar(preguntas).forEach(p => {
            const k = p.texto.trim().toLowerCase();
            if (!vistos.has(k)) { vistos.add(k); unicas.push(p); }
        });

        testActual = {
            nombre: `Test de Repaso - ${new Date().toLocaleDateString('es-ES')}`,
            preguntas: unicas,
            fechaInicio: new Date(),
            temas: ['repaso'],
            esRepaso: true
        };
        preguntaIndex = 0;
        respuestasUsuario = {};
        respondidaActual = false;

        document.getElementById('bottomNav').style.display = 'none';
        document.getElementById('mainHeader').style.display = 'none';
        document.getElementById('configScreen').classList.remove('active');
        document.getElementById('testScreen').style.display = 'block';
        document.getElementById('resultadosScreen').style.display = 'none';
        mostrarPregunta();
    } catch (e) { console.error(e); alert('Error cargando preguntas falladas'); }
};

// ===================== DETALLE HISTORIAL =====================
function abrirDetalleHistorial(resultado) {
    const overlay = document.getElementById('overlayDetalle');
    document.getElementById('detalleTitulo').textContent = resultado.test?.nombre || 'Detalle del test';

    let html = `
        <div class="stats-row" style="padding:0 0 16px;">
            <div class="stat-box c"><div class="num">${resultado.correctas}</div><div class="lbl">Correctas</div></div>
            <div class="stat-box f"><div class="num">${resultado.incorrectas}</div><div class="lbl">Falladas</div></div>
            <div class="stat-box s"><div class="num">${resultado.sinResponder || 0}</div><div class="lbl">Sin resp.</div></div>
        </div>
        <div id="detalleRevisionList"></div>
    `;
    document.getElementById('detalleContenido').innerHTML = html;

    if (resultado.detalleRespuestas && resultado.detalleRespuestas.length > 0) {
        renderizarRevision(resultado.detalleRespuestas, 'detalleRevisionList');
    } else {
        document.getElementById('detalleRevisionList').innerHTML = '<div class="empty-state"><p>No hay detalle de preguntas disponible para este test</p></div>';
    }
    overlay.classList.add('visible');
}

window.cerrarDetalleHistorial = function() {
    document.getElementById('overlayDetalle').classList.remove('visible');
};

// ===================== EXPLICACIONES (solo lectura) =====================
async function abrirExplicacion(textoPregunta) {
    const modal = document.getElementById('modalExplicacion');
    const contenido = document.getElementById('explicacionContenido');
    modal.classList.add('visible');
    contenido.innerHTML = '<div class="expl-empty"><div class="spinner"></div><br>Buscando explicaci√≥n...</div>';

    try {
        const hash = generarHashPregunta(textoPregunta);
        const docId = `${currentUser.uid}_${hash}`;
        let textoExplicacion = '';

        try {
            const geminiRef = doc(db, 'explicacionesGemini', docId);
            const geminiDoc = await getDoc(geminiRef);
            if (geminiDoc.exists() && geminiDoc.data().texto) {
                textoExplicacion = geminiDoc.data().texto;
            }
        } catch (e) {}

        if (!textoExplicacion) {
            try {
                const userRef = doc(db, `usuarios/${currentUser.uid}/explicaciones`, hash);
                const userDoc = await getDoc(userRef);
                if (userDoc.exists() && userDoc.data().gemini) {
                    textoExplicacion = userDoc.data().gemini;
                }
            } catch (e) {}
        }

        if (textoExplicacion) {
            contenido.innerHTML = `<div class="expl-content">${textoExplicacion}</div>`;
        } else {
            contenido.innerHTML = '<div class="expl-empty">üì≠ No hay explicaci√≥n guardada para esta pregunta.<br><br>Puedes a√±adir explicaciones desde la plataforma web.</div>';
        }
    } catch (e) {
        console.error('Error cargando explicaci√≥n:', e);
        contenido.innerHTML = '<div class="expl-empty">‚ö†Ô∏è Error al cargar la explicaci√≥n</div>';
    }
}

window.cerrarExplicacionModal = function(e) {
    if (e && e.target !== e.currentTarget) return;
    document.getElementById('modalExplicacion').classList.remove('visible');
};
async function borrarResultado(docId, elemento) {
    if (!confirm('¬øEliminar este resultado?')) return;
    try {
        await deleteDoc(doc(db, "resultados", docId));
        elemento.style.transition = 'opacity 0.3s, transform 0.3s';
        elemento.style.opacity = '0';
        elemento.style.transform = 'translateX(100%)';
        setTimeout(() => {
            elemento.remove();
            if (!document.querySelector('.historial-item')) {
                document.getElementById('historialList').innerHTML = '<div class="empty-state"><div class="icon">üìã</div><p>Todav√≠a no has hecho ning√∫n test</p></div>';
            }
        }, 300);
    } catch (e) {
        console.error(e);
        alert('Error al eliminar');
    }
}
</script>
</body>
</html>
